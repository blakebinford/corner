{% extends 'base.html' %}
{% load static %}
{% load key_filter %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar">
            <div class="accordion" id="eventsAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="eventsHeading">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                data-bs-target="#eventsCollapse" aria-expanded="true" aria-controls="eventsCollapse">
                            Events
                        </button>
                    </h2>
                    <div id="eventsCollapse" class="accordion-collapse collapse show" aria-labelledby="eventsHeading"
                         data-bs-parent="#eventsAccordion">
                        <div class="accordion-body p-0">
                            <div class="list-group">
                                {% for event in events %}
                                    <a href="{% url 'competitions:competition_run_order' competition.pk event.pk %}"
                                       class="list-group-item list-group-item-action {% if event == current_event %}active{% endif %}">
                                        {{ event.name }}
                                    </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-10 main-content">
            {% if current_event %}
                <h2>{{ current_event.name }} Run Order</h2>

                <!-- Event Controls -->
                <div class="row mb-3">
                    <div class="col">
                        <form method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="generate_run_order">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-sync"></i> Generate Run Order
                            </button>
                        </form>
                    </div>
                </div>

                {% if run_orders %}
                    {% if current_event.number_of_lanes > 1 %}
                        <!-- Multi-Lane Layout with Tabs -->
                        <ul class="nav nav-tabs mb-3" id="laneTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="all-lanes-tab" data-bs-toggle="tab"
                                        data-bs-target="#all-lanes" type="button" role="tab"
                                        aria-controls="all-lanes" aria-selected="true">
                                    All Lanes Overview
                                </button>
                            </li>
                            {% for lane_number, lane_data in lanes_data.items %}
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="lane-{{ lane_number }}-tab" data-bs-toggle="tab"
                                            data-bs-target="#lane-{{ lane_number }}" type="button" role="tab"
                                            aria-controls="lane-{{ lane_number }}" aria-selected="false">
                                        Lane {{ lane_number }}
                                        {% if lane_data.current %}
                                            <span class="badge bg-success">Active</span>
                                        {% endif %}
                                    </button>
                                </li>
                            {% endfor %}
                        </ul>

                        <div class="tab-content" id="laneTabsContent">
                            <!-- All Lanes Overview Tab -->
                            <div class="tab-pane fade show active" id="all-lanes" role="tabpanel" aria-labelledby="all-lanes-tab">
                                <div class="row">
                                    {% for lane_number, lane_data in lanes_data.items %}
                                        <div class="col-12 mb-4">
                                            <div class="card">
                                                <div class="card-header bg-primary text-white">
                                                    <h4 class="mb-0">Lane {{ lane_number }}</h4>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <!-- Current Lifter -->
                                                        {% if lane_data.current %}
                                                            <div class="col-md-6 mb-3">
                                                                <div class="card border-success shadow-lg h-100 current-lifter-card">
                                                                    <div class="card-header bg-success text-white">
                                                                        <h5 class="mb-0">Current Lifter - Lane {{ lane_number }}</h5>
                                                                    </div>
                                                                    <div class="card-body">
                                                                        <h4 class="fw-bold">{{ lane_data.current.athlete_competition.athlete.user.get_full_name }}</h4>
                                                                        <p>
                                                                            <strong>Division:</strong> {{ lane_data.current.athlete_competition.division.name|capfirst }}<br>
                                                                            <strong>Weight Class:</strong> {{ lane_data.current.athlete_competition.weight_class.weight_d }}{{ lane_data.current.athlete_competition.weight_class.name }}<br>
                                                                            <strong>Heat:</strong> {{ lane_data.current.heat_number }}
                                                                        </p>
                                                                        <!-- Notes Display -->
                                                                        {% with athlete_notes=event_notes|get_item:lane_data.current.athlete_competition.pk %}
                                                                            {% if athlete_notes %}
                                                                                {% with event_specific_notes=athlete_notes|get_item:current_event.pk %}
                                                                                    {% if event_specific_notes %}
                                                                                        <div class="alert alert-info mb-0">
                                                                                            <strong>Notes:</strong>
                                                                                            <ul class="list-unstyled mb-0">
                                                                                                {% for note_type, note_value in event_specific_notes.items %}
                                                                                                    <li><strong>{{ note_type|title }}:</strong> {{ note_value }}</li>
                                                                                                {% endfor %}
                                                                                            </ul>
                                                                                        </div>
                                                                                    {% endif %}
                                                                                {% endwith %}
                                                                            {% endif %}
                                                                        {% endwith %}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endif %}

                                                        <!-- On Deck Lifter -->
                                                        {% if lane_data.on_deck %}
                                                            <div class="col-md-6 mb-3">
                                                                <div class="card border-info h-100">
                                                                    <div class="card-header bg-info text-white">
                                                                        <h5 class="mb-0">On Deck - Lane {{ lane_number }}</h5>
                                                                    </div>
                                                                    <div class="card-body">
                                                                        <h5>{{ lane_data.on_deck.athlete_competition.athlete.user.get_full_name }}</h5>
                                                                        <p>
                                                                            <strong>Division:</strong> {{ lane_data.on_deck.athlete_competition.division.name|capfirst }}<br>
                                                                            <strong>Weight Class:</strong> {{ lane_data.on_deck.athlete_competition.weight_class.weight_d }}{{ lane_data.on_deck.athlete_competition.weight_class.name }}<br>
                                                                            <strong>Heat:</strong> {{ lane_data.on_deck.heat_number }}
                                                                        </p>
                                                                        <!-- Notes Display -->
                                                                        {% with athlete_notes=event_notes|get_item:lane_data.on_deck.athlete_competition.pk %}
                                                                            {% if athlete_notes %}
                                                                                {% with event_specific_notes=athlete_notes|get_item:current_event.pk %}
                                                                                    {% if event_specific_notes %}
                                                                                        <div class="alert alert-info mb-0">
                                                                                            <strong>Notes:</strong>
                                                                                            <ul class="list-unstyled mb-0">
                                                                                                {% for note_type, note_value in event_specific_notes.items %}
                                                                                                    <li><strong>{{ note_type|title }}:</strong> {{ note_value }}</li>
                                                                                                {% endfor %}
                                                                                            </ul>
                                                                                        </div>
                                                                                    {% endif %}
                                                                                {% endwith %}
                                                                            {% endif %}
                                                                        {% endwith %}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                    </div>

                                                    <!-- Lane Action Buttons -->
                                                    <div class="mb-3">
                                                        {% if lane_data.current %}
                                                            <form method="post" class="d-inline">
                                                                {% csrf_token %}
                                                                <input type="hidden" name="action" value="complete_current_lifter">
                                                                <input type="hidden" name="run_order_id" value="{{ lane_data.current.pk }}">
                                                                <button type="submit" class="btn btn-success">
                                                                    <i class="fas fa-check-circle"></i> Complete Lift & Advance
                                                                </button>
                                                            </form>
                                                        {% endif %}
                                                        {% if lane_data.on_deck %}
                                                            <form method="post" class="d-inline">
                                                                {% csrf_token %}
                                                                <input type="hidden" name="action" value="update_current_lifter">
                                                                <input type="hidden" name="run_order_id" value="{{ lane_data.on_deck.pk }}">
                                                                <button type="submit" class="btn btn-primary">
                                                                    <i class="fas fa-forward"></i> Make Current
                                                                </button>
                                                            </form>
                                                        {% endif %}
                                                        <a href="#lane-{{ lane_number }}" class="btn btn-outline-primary"
                                                           data-bs-toggle="tab" role="tab" aria-controls="lane-{{ lane_number }}">
                                                            <i class="fas fa-expand-alt"></i> Full View
                                                        </a>
                                                    </div>

                                                    <!-- Heats Summary -->
                                                    <div class="card mb-3">
                                                        <div class="card-header bg-light">
                                                            <h5 class="mb-0">Heats Summary</h5>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="row">
                                                                {% for heat_number in lane_data.heats %}
                                                                    <div class="col-md-3 mb-2">
                                                                        <div class="card h-100">
                                                                            <div class="card-header">Heat {{ heat_number }}</div>
                                                                            <div class="card-body p-2">
                                                                                {% with heat_athletes=run_orders|dictsort:"order"|dictsortreversed:"status" %}
                                                                                    {% for athlete in heat_athletes %}
                                                                                        {% if athlete.lane_number == lane_number and athlete.heat_number == heat_number %}
                                                                                            <div class="mb-1 {% if athlete.status == 'current' %}text-success fw-bold{% elif athlete.status == 'completed' %}text-muted text-decoration-line-through{% endif %}">
                                                                                                {{ athlete.athlete_competition.athlete.user.get_full_name|truncatechars:20 }}
                                                                                            </div>
                                                                                        {% endif %}
                                                                                    {% endfor %}
                                                                                {% endwith %}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Individual Lane Tabs -->
                            {% for lane_number, lane_data in lanes_data.items %}
                                <div class="tab-pane fade" id="lane-{{ lane_number }}" role="tabpanel"
                                     aria-labelledby="lane-{{ lane_number }}-tab">
                                    <div class="row">
                                        <!-- Current and On Deck Section -->
                                        <div class="col-md-12 mb-4">
                                            <div class="row">
                                                <!-- Current Lifter Card -->
                                                {% if lane_data.current %}
                                                    <div class="col-md-6 mb-3">
                                                        <div class="card border-success shadow-lg h-100 current-lifter-card">
                                                            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                                                <h4 class="mb-0">Current Lifter - Lane {{ lane_number }}</h4>
                                                                <button type="button"
                                                                        class="btn btn-outline-light btn-sm"
                                                                        data-bs-toggle="modal"
                                                                        data-bs-target="#notesModal{{ lane_data.current.athlete_competition.pk }}">
                                                                    <i class="bi bi-pencil-square"></i> Update Notes
                                                                </button>
                                                            </div>
                                                            <div class="card-body">
                                                                <h4 class="fw-bold">{{ lane_data.current.athlete_competition.athlete.user.get_full_name }}</h4>
                                                                <div class="row">
                                                                    <div class="col-md-6">
                                                                        <p>
                                                                            <strong>Division:</strong> {{ lane_data.current.athlete_competition.division.name|capfirst }}<br>
                                                                            <strong>Weight Class:</strong> {{ lane_data.current.athlete_competition.weight_class.weight_d }}{{ lane_data.current.athlete_competition.weight_class.name }}
                                                                        </p>
                                                                        <p><strong>Heat:</strong> {{ lane_data.current.heat_number }}</p>
                                                                    </div>
                                                                    <div class="col-md-6">
                                                                        {% with athlete_notes=event_notes|get_item:lane_data.current.athlete_competition.pk %}
                                                                            {% if athlete_notes %}
                                                                                {% with event_specific_notes=athlete_notes|get_item:current_event.pk %}
                                                                                    {% if event_specific_notes %}
                                                                                        <div class="card bg-light">
                                                                                            <div class="card-header py-1 bg-light text-dark">
                                                                                                <strong>Event Notes</strong>
                                                                                            </div>
                                                                                            <div class="card-body py-2">
                                                                                                <ul class="list-unstyled mb-0">
                                                                                                    {% for note_type, note_value in event_specific_notes.items %}
                                                                                                        <li><strong>{{ note_type|title }}:</strong> {{ note_value }}</li>
                                                                                                    {% endfor %}
                                                                                                </ul>
                                                                                            </div>
                                                                                        </div>
                                                                                    {% endif %}
                                                                                {% endwith %}
                                                                            {% endif %}
                                                                        {% endwith %}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="card-footer bg-light">
                                                                <form method="post" class="d-inline">
                                                                    {% csrf_token %}
                                                                    <input type="hidden" name="action" value="complete_current_lifter">
                                                                    <input type="hidden" name="run_order_id" value="{{ lane_data.current.pk }}">
                                                                    <button type="submit" class="btn btn-success w-100">
                                                                        <i class="fas fa-check-circle"></i> Complete Lift & Advance
                                                                    </button>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endif %}

                                                <!-- On Deck Lifter Card -->
                                                {% if lane_data.on_deck %}
                                                    <div class="col-md-6 mb-3">
                                                        <div class="card border-info h-100">
                                                            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                                                <h4 class="mb-0">On Deck - Lane {{ lane_number }}</h4>
                                                                <button type="button"
                                                                        class="btn btn-outline-light btn-sm"
                                                                        data-bs-toggle="modal"
                                                                        data-bs-target="#notesModal{{ lane_data.on_deck.athlete_competition.pk }}">
                                                                    <i class="bi bi-pencil-square"></i> Update Notes
                                                                </button>
                                                            </div>
                                                            <div class="card-body">
                                                                <h5>{{ lane_data.on_deck.athlete_competition.athlete.user.get_full_name }}</h5>
                                                                <div class="row">
                                                                    <div class="col-md-6">
                                                                        <p>
                                                                            <strong>Division:</strong> {{ lane_data.on_deck.athlete_competition.division.name|capfirst }}<br>
                                                                            <strong>Weight Class:</strong> {{ lane_data.on_deck.athlete_competition.weight_class.weight_d }}{{ lane_data.on_deck.athlete_competition.weight_class.name }}
                                                                        </p>
                                                                        <p><strong>Heat:</strong> {{ lane_data.on_deck.heat_number }}</p>
                                                                    </div>
                                                                    <div class="col-md-6">
                                                                        {% with athlete_notes=event_notes|get_item:lane_data.on_deck.athlete_competition.pk %}
                                                                            {% if athlete_notes %}
                                                                                {% with event_specific_notes=athlete_notes|get_item:current_event.pk %}
                                                                                    {% if event_specific_notes %}
                                                                                        <div class="card bg-light">
                                                                                            <div class="card-header py-1 bg-light text-dark">
                                                                                                <strong>Event Notes</strong>
                                                                                            </div>
                                                                                            <div class="card-body py-2">
                                                                                                <ul class="list-unstyled mb-0">
                                                                                                    {% for note_type, note_value in event_specific_notes.items %}
                                                                                                        <li><strong>{{ note_type|title }}:</strong> {{ note_value }}</li>
                                                                                                    {% endfor %}
                                                                                                </ul>
                                                                                            </div>
                                                                                        </div>
                                                                                    {% endif %}
                                                                                {% endwith %}
                                                                            {% endif %}
                                                                        {% endwith %}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="card-footer bg-light">
                                                                <form method="post" class="d-inline">
                                                                    {% csrf_token %}
                                                                    <input type="hidden" name="action" value="update_current_lifter">
                                                                    <input type="hidden" name="run_order_id" value="{{ lane_data.on_deck.pk }}">
                                                                    <button type="submit" class="btn btn-primary w-100">
                                                                        <i class="fas fa-forward"></i> Mark as Current
                                                                    </button>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Upcoming Lifters Table -->
                                        <div class="col-md-12 mb-4">
                                            <div class="card">
                                                <div class="card-header bg-primary text-white">
                                                    <h4 class="mb-0">Upcoming Lifters - Lane {{ lane_number }}</h4>
                                                </div>
                                                <div class="card-body p-0">
                                                    <div class="table-responsive">
                                                        <table class="table table-striped table-hover mb-0">
                                                            <thead>
                                                                <tr>
                                                                    <th>Order</th>
                                                                    <th>Athlete</th>
                                                                    <th>Division</th>
                                                                    <th>Weight Class</th>
                                                                    <th>Heat</th>
                                                                    <th>Notes</th>
                                                                    <th>Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for pending in lane_data.pending %}
                                                                    <tr>
                                                                        <td>{{ pending.order }}</td>
                                                                        <td>{{ pending.athlete_competition.athlete.user.get_full_name }}</td>
                                                                        <td>{{ pending.athlete_competition.division.name|capfirst }}</td>
                                                                        <td>{{ pending.athlete_competition.weight_class.weight_d }}{{ pending.athlete_competition.weight_class.name }}</td>
                                                                        <td>{{ pending.heat_number }}</td>
                                                                        <td>
                                                                            <button type="button"
                                                                                    class="btn btn-outline-primary btn-sm"
                                                                                    data-bs-toggle="modal"
                                                                                    data-bs-target="#notesModal{{ pending.athlete_competition.pk }}">
                                                                                <i class="bi bi-pencil-square"></i> Event Notes
                                                                                {% with athlete_notes=event_notes|get_item:pending.athlete_competition.pk %}
                                                                                    {% if athlete_notes %}
                                                                                        {% with event_specific_notes=athlete_notes|get_item:current_event.pk %}
                                                                                            {% if event_specific_notes %}
                                                                                                <span class="badge bg-info">{{ event_specific_notes|length }}</span>
                                                                                            {% endif %}
                                                                                        {% endwith %}
                                                                                    {% endif %}
                                                                                {% endwith %}
                                                                            </button>
                                                                        </td>
                                                                        <td>
                                                                            <form method="post" class="d-inline">
                                                                                {% csrf_token %}
                                                                                <input type="hidden" name="action" value="update_current_lifter">
                                                                                <input type="hidden" name="run_order_id" value="{{ pending.pk }}">
                                                                                <button type="submit" class="btn btn-sm btn-primary">
                                                                                    <i class="fas fa-forward"></i> Make Current
                                                                                </button>
                                                                            </form>
                                                                        </td>
                                                                    </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Completed Lifters Table -->
                                        <div class="col-md-12 mb-4">
                                            <div class="card">
                                                <div class="card-header bg-secondary text-white">
                                                    <h4 class="mb-0">Completed Lifters - Lane {{ lane_number }}</h4>
                                                </div>
                                                <div class="card-body p-0">
                                                    <div class="table-responsive">
                                                        <table class="table table-striped table-hover mb-0">
                                                            <thead>
                                                                <tr>
                                                                    <th>Order</th>
                                                                    <th>Athlete</th>
                                                                    <th>Division</th>
                                                                    <th>Weight Class</th>
                                                                    <th>Heat</th>
                                                                    <th>Notes</th>
                                                                    <th>Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for completed in lane_data.completed %}
                                                                    <tr class="table-success">
                                                                        <td>{{ completed.order }}</td>
                                                                        <td>{{ completed.athlete_competition.athlete.user.get_full_name }}</td>
                                                                        <td>{{ completed.athlete_competition.division.name|capfirst }}</td>
                                                                        <td>{{ completed.athlete_competition.weight_class.weight_d }}{{ completed.athlete_competition.weight_class.name }}</td>
                                                                        <td>{{ completed.heat_number }}</td>
                                                                        <td>
                                                                            <button type="button"
                                                                                    class="btn btn-outline-secondary btn-sm"
                                                                                    data-bs-toggle="modal"
                                                                                    data-bs-target="#notesModal{{ completed.athlete_competition.pk }}">
                                                                                <i class="bi bi-eye"></i> View Notes
                                                                            </button>
                                                                        </td>
                                                                        <td>
                                                                            <form method="post" class="d-inline">
                                                                                {% csrf_token %}
                                                                                <input type="hidden" name="action" value="reactivate_lifter">
                                                                                <input type="hidden" name="run_order_id" value="{{ completed.pk }}">
                                                                                <button type="submit" class="btn btn-sm btn-warning">
                                                                                    <i class="fas fa-redo"></i> Reactivate
                                                                                </button>
                                                                            </form>
                                                                        </td>
                                                                    </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <!-- Single Lane, Single Heat Layout -->
                        {% with lane_data=lanes_data.1 %}
                            <div class="row">
                                <!-- Current Lifter -->
                                {% if lane_data.current %}
                                    <div class="col-md-12 mb-4">
                                        <div class="card border-success shadow-lg current-lifter-card">
                                            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                                <h4 class="mb-0">Current Lifter</h4>
                                                <button type="button"
                                                        class="btn btn-outline-light btn-sm"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#notesModal{{ lane_data.current.athlete_competition.pk }}">
                                                    <i class="bi bi-pencil-square"></i> Update Notes
                                                </button>
                                            </div>
                                            <div class="card-body">
                                                <h4 class="fw-bold">{{ lane_data.current.athlete_competition.athlete.user.get_full_name }}</h4>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <p>
                                                            <strong>Division:</strong> {{ lane_data.current.athlete_competition.division.name|capfirst }}<br>
                                                            <strong>Weight Class:</strong> {{ lane_data.current.athlete_competition.weight_class.weight_d }}{{ lane_data.current.athlete_competition.weight_class.name }}
                                                        </p>
                                                    </div>
                                                    <div class="col-md-6">
                                                        {% with athlete_notes=event_notes|get_item:lane_data.current.athlete_competition.pk %}
                                                            {% if athlete_notes %}
                                                                {% with event_specific_notes=athlete_notes|get_item:current_event.pk %}
                                                                    {% if event_specific_notes %}
                                                                        <div class="card bg-light">
                                                                            <div class="card-header py-1 bg-light text-dark">
                                                                                <strong>Event Notes</strong>
                                                                            </div>
                                                                            <div class="card-body py-2">
                                                                                <ul class="list-unstyled mb-0">
                                                                                    {% for note_type, note_value in event_specific_notes.items %}
                                                                                        <li><strong>{{ note_type|title }}:</strong> {{ note_value }}</li>
                                                                                    {% endfor %}
                                                                                </ul>
                                                                            </div>
                                                                        </div>
                                                                    {% endif %}
                                                                {% endwith %}
                                                            {% endif %}
                                                        {% endwith %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-footer bg-light">
                                                <form method="post" class="d-inline">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="complete_current_lifter">
                                                    <input type="hidden" name="run_order_id" value="{{ lane_data.current.pk }}">
                                                    <button type="submit" class="btn btn-success w-100">
                                                        <i class="fas fa-check-circle"></i> Complete Lift & Advance
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}

                                <!-- On Deck Lifter -->
                                {% if lane_data.on_deck %}
                                    <div class="col-md-12 mb-4">
                                        <div class="card border-info h-100">
                                            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                                <h4 class="mb-0">On Deck</h4>
                                                <button type="button"
                                                        class="btn btn-outline-light btn-sm"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#notesModal{{ lane_data.on_deck.athlete_competition.pk }}">
                                                    <i class="bi bi-pencil-square"></i> Update Notes
                                                </button>
                                            </div>
                                            <div class="card-body">
                                                <h5>{{ lane_data.on_deck.athlete_competition.athlete.user.get_full_name }}</h5>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <p>
                                                            <strong>Division:</strong> {{ lane_data.on_deck.athlete_competition.division.name|capfirst }}<br>
                                                            <strong>Weight Class:</strong> {{ lane_data.on_deck.athlete_competition.weight_class.weight_d }}{{ lane_data.on_deck.athlete_competition.weight_class.name }}
                                                        </p>
                                                    </div>
                                                    <div class="col-md-6">
                                                        {% with athlete_notes=event_notes|get_item:lane_data.on_deck.athlete_competition.pk %}
                                                            {% if athlete_notes %}
                                                                {% with event_specific_notes=athlete_notes|get_item:current_event.pk %}
                                                                    {% if event_specific_notes %}
                                                                        <div class="card bg-light">
                                                                            <div class="card-header py-1 bg-light text-dark">
                                                                                <strong>Event Notes</strong>
                                                                            </div>
                                                                            <div class="card-body py-2">
                                                                                <ul class="list-unstyled mb-0">
                                                                                    {% for note_type, note_value in event_specific_notes.items %}
                                                                                        <li><strong>{{ note_type|title }}:</strong> {{ note_value }}</li>
                                                                                    {% endfor %}
                                                                                </ul>
                                                                            </div>
                                                                        </div>
                                                                    {% endif %}
                                                                {% endwith %}
                                                            {% endif %}
                                                        {% endwith %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-footer bg-light">
                                                <form method="post" class="d-inline">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="update_current_lifter">
                                                    <input type="hidden" name="run_order_id" value="{{ lane_data.on_deck.pk }}">
                                                    <button type="submit" class="btn btn-primary w-100">
                                                        <i class="fas fa-forward"></i> Mark as Current
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}

                                <!-- Upcoming Lifters Table -->
                                <div class="col-md-12 mb-4">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <h4 class="mb-0">Upcoming Lifters</h4>
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-hover mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th>Order</th>
                                                            <th>Athlete</th>
                                                            <th>Division</th>
                                                            <th>Weight Class</th>
                                                            <th>Notes</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for pending in lane_data.pending %}
                                                            <tr>
                                                                <td>{{ pending.order }}</td>
                                                                <td>{{ pending.athlete_competition.athlete.user.get_full_name }}</td>
                                                                <td>{{ pending.athlete_competition.division.name|capfirst }}</td>
                                                                <td>{{ pending.athlete_competition.weight_class.weight_d }}{{ pending.athlete_competition.weight_class.name }}</td>
                                                                <td>
                                                                    <button type="button"
                                                                            class="btn btn-outline-primary btn-sm"
                                                                            data-bs-toggle="modal"
                                                                            data-bs-target="#notesModal{{ pending.athlete_competition.pk }}">
                                                                        <i class="bi bi-pencil-square"></i> Event Notes
                                                                        {% with athlete_notes=event_notes|get_item:pending.athlete_competition.pk %}
                                                                            {% if athlete_notes %}
                                                                                {% with event_specific_notes=athlete_notes|get_item:current_event.pk %}
                                                                                    {% if event_specific_notes %}
                                                                                        <span class="badge bg-info">{{ event_specific_notes|length }}</span>
                                                                                    {% endif %}
                                                                                {% endwith %}
                                                                            {% endif %}
                                                                        {% endwith %}
                                                                    </button>
                                                                </td>
                                                                <td>
                                                                    <form method="post" class="d-inline">
                                                                        {% csrf_token %}
                                                                        <input type="hidden" name="action" value="update_current_lifter">
                                                                        <input type="hidden" name="run_order_id" value="{{ pending.pk }}">
                                                                        <button type="submit" class="btn btn-sm btn-primary">
                                                                            <i class="fas fa-forward"></i> Make Current
                                                                        </button>
                                                                    </form>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Completed Lifters Table -->
                                <div class="col-md-12 mb-4">
                                    <div class="card">
                                        <div class="card-header bg-secondary text-white">
                                            <h4 class="mb-0">Completed Lifters</h4>
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-hover mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th>Order</th>
                                                            <th>Athlete</th>
                                                            <th>Division</th>
                                                            <th>Weight Class</th>
                                                            <th>Notes</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for completed in lane_data.completed %}
                                                            <tr class="table-success">
                                                                <td>{{ completed.order }}</td>
                                                                <td>{{ completed.athlete_competition.athlete.user.get_full_name }}</td>
                                                                <td>{{ completed.athlete_competition.division.name|capfirst }}</td>
                                                                <td>{{ completed.athlete_competition.weight_class.weight_d }}{{ completed.athlete_competition.weight_class.name }}</td>
                                                                <td>
                                                                    <button type="button"
                                                                            class="btn btn-outline-secondary btn-sm"
                                                                            data-bs-toggle="modal"
                                                                            data-bs-target="#notesModal{{ completed.athlete_competition.pk }}">
                                                                        <i class="bi bi-eye"></i> View Notes
                                                                    </button>
                                                                </td>
                                                                <td>
                                                                    <form method="post" class="d-inline">
                                                                        {% csrf_token %}
                                                                        <input type="hidden" name="action" value="reactivate_lifter">
                                                                        <input type="hidden" name="run_order_id" value="{{ completed.pk }}">
                                                                        <button type="submit" class="btn btn-sm btn-warning">
                                                                            <i class="fas fa-redo"></i> Reactivate
                                                                        </button>
                                                                    </form>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endwith %}
                    {% endif %}

                    <!-- Notes Modals (unchanged) -->
                    {% for run_order in run_orders %}
                        <div class="modal fade" id="notesModal{{ run_order.athlete_competition.pk }}" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">
                                            Event Notes: {{ run_order.athlete_competition.athlete.user.get_full_name }}
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="accordion" id="eventNotesAccordion{{ run_order.athlete_competition.pk }}">
                                            {% for event in events %}
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header" id="event{{ event.pk }}Heading{{ run_order.athlete_competition.pk }}">
                                                        <button class="accordion-button {% if event != current_event %}collapsed{% endif %}" type="button"
                                                            data-bs-toggle="collapse"
                                                            data-bs-target="#event{{ event.pk }}Collapse{{ run_order.athlete_competition.pk }}">
                                                            {{ event.name }} ({{ event.get_weight_type_display }})
                                                        </button>
                                                    </h2>
                                                    <div id="event{{ event.pk }}Collapse{{ run_order.athlete_competition.pk }}"
                                                         class="accordion-collapse collapse {% if event == current_event %}show{% endif %}"
                                                         data-bs-parent="#eventNotesAccordion{{ run_order.athlete_competition.pk }}">
                                                        <div class="accordion-body">
                                                            <div class="notes-container" data-athlete="{{ run_order.athlete_competition.pk }}" data-event="{{ event.pk }}">
                                                                {% with athlete_notes=event_notes|get_item:run_order.athlete_competition.pk %}
                                                                    {% with event_specific_notes=athlete_notes|get_item:event.pk %}
                                                                        {% if event_specific_notes %}
                                                                            {% for note_type, note_value in event_specific_notes.items %}
                                                                                <div class="note-row mb-2 row">
                                                                                    <div class="col-md-4">
                                                                                        <select name="note_type_{{ run_order.athlete_competition.pk }}_{{ event.pk }}" class="form-select note-type-select">
                                                                                            <option value="">-- Select Type --</option>
                                                                                            <option value="general" {% if note_type == 'general' %}selected{% endif %}>General Note</option>
                                                                                            <option value="equipment" {% if note_type == 'equipment' %}selected{% endif %}>Equipment Note</option>
                                                                                            {% if event.weight_type == 'max' %}
                                                                                                <option value="opening_weight" {% if note_type == 'opening_weight' %}selected{% endif %}>Opening Weight</option>
                                                                                                <option value="next_attempt" {% if note_type == 'next_attempt' %}selected{% endif %}>Next Attempt</option>
                                                                                                <option value="rack_height" {% if note_type == 'rack_height' %}selected{% endif %}>Rack Height</option>
                                                                                            {% elif event.weight_type == 'time' %}
                                                                                                <option value="target_time" {% if note_type == 'target_time' %}selected{% endif %}>Target Time</option>
                                                                                                <option value="strategy" {% if note_type == 'strategy' %}selected{% endif %}>Strategy</option>
                                                                                            {% elif event.weight_type == 'distance' %}
                                                                                                <option value="implement_selection" {% if note_type == 'implement_selection' %}selected{% endif %}>Implement Selection</option>
                                                                                            {% elif event.weight_type == 'reps' %}
                                                                                                <option value="target_reps" {% if note_type == 'target_reps' %}selected{% endif %}>Target Reps</option>
                                                                                            {% endif %}
                                                                                            <option value="custom" {% if note_type == 'custom' %}selected{% endif %}>Custom</option>
                                                                                        </select>
                                                                                    </div>
                                                                                    <div class="col-md-6">
                                                                                        <input type="text"
                                                                                               name="note_value_{{ run_order.athlete_competition.pk }}_{{ event.pk }}"
                                                                                               class="form-control"
                                                                                               placeholder="Note value"
                                                                                               value="{{ note_value }}">
                                                                                    </div>
                                                                                    <div class="col-md-2">
                                                                                        <button type="button" class="btn btn-danger btn-sm remove-note">
                                                                                            <i class="bi bi-trash"></i>
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                            {% endfor %}
                                                                        {% else %}
                                                                            <div class="note-row mb-2 row">
                                                                                <div class="col-md-4">
                                                                                    <select name="note_type_{{ run_order.athlete_competition.pk }}_{{ event.pk }}" class="form-select note-type-select">
                                                                                        <option value="">-- Select Type --</option>
                                                                                        <option value="general">General Note</option>
                                                                                        <option value="equipment">Equipment Note</option>
                                                                                        {% if event.weight_type == 'max' %}
                                                                                            <option value="opening_weight">Opening Weight</option>
                                                                                            <option value="next_attempt">Next Attempt</option>
                                                                                            <option value="rack_height">Rack Height</option>
                                                                                        {% elif event.weight_type == 'time' %}
                                                                                            <option value="target_time">Target Time</option>
                                                                                            <option value="strategy">Strategy</option>
                                                                                        {% elif event.weight_type == 'distance' %}
                                                                                            <option value="implement_selection">Implement Selection</option>
                                                                                        {% elif event.weight_type == 'reps' %}
                                                                                            <option value="target_reps">Target Reps</option>
                                                                                        {% endif %}
                                                                                        <option value="custom">Custom</option>
                                                                                    </select>
                                                                                </div>
                                                                                <div class="col-md-6">
                                                                                    <input type="text"
                                                                                           name="note_value_{{ run_order.athlete_competition.pk }}_{{ event.pk }}"
                                                                                           class="form-control"
                                                                                           placeholder="Note value">
                                                                                </div>
                                                                                <div class="col-md-2">
                                                                                    <button type="button" class="btn btn-danger btn-sm remove-note">
                                                                                        <i class="bi bi-trash"></i>
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        {% endif %}
                                                                    {% endwith %}
                                                                {% endwith %}
                                                                <button type="button" class="btn btn-outline-success btn-sm add-note-btn mt-2"
                                                                        data-athlete="{{ run_order.athlete_competition.pk }}"
                                                                        data-event="{{ event.pk }}">
                                                                    <i class="bi bi-plus-circle"></i> Add Note
                                                                </button>
                                                                <div class="mt-3">
                                                                    <form method="post" class="save-note-form">
                                                                        {% csrf_token %}
                                                                        <input type="hidden" name="action" value="save_event_note">
                                                                        <input type="hidden" name="athlete_competition_id" value="{{ run_order.athlete_competition.pk }}">
                                                                        <input type="hidden" name="event_pk" value="{{ event.pk }}">
                                                                        <input type="hidden" name="note_type" class="note-type-hidden">
                                                                        <input type="hidden" name="note_value" class="note-value-hidden">
                                                                        <button type="submit" class="btn btn-primary save-notes-btn">
                                                                            <i class="bi bi-save"></i> Save Notes
                                                                        </button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        No run order has been generated for this event yet. Click the "Generate Run Order" button to create one.
                    </div>
                {% endif %}
            {% else %}
                <div class="alert alert-info">
                    No events available for this competition.
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .sidebar {
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        height: 100vh;
        overflow-y: auto;
    }

    .main-content {
        padding: 20px;
    }

    .card-body ul li {
        margin-bottom: 5px;
    }

    .table td, .table th {
        vertical-align: middle;
    }

    .nav-tabs .nav-link {
        font-weight: 500;
    }

    .nav-tabs .nav-link.active {
        border-bottom: 2px solid #0d6efd;
    }

    .heats-container .card {
        transition: all 0.2s ease;
    }

    .heats-container .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* Emphasize Current Lifter */
    .current-lifter-card {
        border-width: 3px;
    }

    .current-lifter-card .card-header {
        font-size: 1.25rem;
    }

    .current-lifter-card h4 {
        font-size: 1.75rem;
        color: #198754; /* Success green */
    }

    /* Sidebar Accordion */
    .accordion-button {
        background-color: #f8f9fa;
        color: #212529;
    }

    .accordion-button:not(.collapsed) {
        background-color: #e9ecef;
        color: #0d6efd;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add Note Button Click Handler
        document.querySelectorAll('.add-note-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                const container = this.closest('.notes-container');
                const athlete = container.dataset.athlete;
                const event = container.dataset.event;

                const firstRow = container.querySelector('.note-row');
                const newRow = firstRow.cloneNode(true);

                newRow.querySelector('select').value = '';
                newRow.querySelector('input').value = '';

                newRow.querySelector('.remove-note').addEventListener('click', function() {
                    if (container.querySelectorAll('.note-row').length > 1) {
                        this.closest('.note-row').remove();
                    }
                });

                container.insertBefore(newRow, button);
            });
        });

        // Remove Note Button Click Handler
        document.querySelectorAll('.remove-note').forEach(function(button) {
            button.addEventListener('click', function() {
                const container = this.closest('.notes-container');
                if (container.querySelectorAll('.note-row').length > 1) {
                    this.closest('.note-row').remove();
                }
            });
        });

        // Save Notes Form Submit Handler
        document.querySelectorAll('.save-note-form').forEach(function(form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const container = this.closest('.notes-container');
                const athlete = container.dataset.athlete;
                const event = container.dataset.event;
                const rows = container.querySelectorAll('.note-row');

                rows.forEach(function(row, index) {
                    const noteType = row.querySelector('select').value;
                    const noteValue = row.querySelector('input').value;

                    if (noteType && noteValue) {
                        const noteForm = document.createElement('form');
                        noteForm.method = 'post';
                        noteForm.style.display = 'none';

                        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
                        const csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = 'csrfmiddlewaretoken';
                        csrfInput.value = csrfToken;
                        noteForm.appendChild(csrfInput);

                        const actionInput = document.createElement('input');
                        actionInput.type = 'hidden';
                        actionInput.name = 'action';
                        actionInput.value = 'save_event_note';
                        noteForm.appendChild(actionInput);

                        const athleteInput = document.createElement('input');
                        athleteInput.type = 'hidden';
                        athleteInput.name = 'athlete_competition_id';
                        athleteInput.value = athlete;
                        noteForm.appendChild(athleteInput);

                        const eventInput = document.createElement('input');
                        eventInput.type = 'hidden';
                        eventInput.name = 'event_pk';
                        eventInput.value = event;
                        noteForm.appendChild(eventInput);

                        const noteTypeInput = document.createElement('input');
                        noteTypeInput.type = 'hidden';
                        noteTypeInput.name = 'note_type';
                        noteTypeInput.value = noteType;
                        noteForm.appendChild(noteTypeInput);

                        const noteValueInput = document.createElement('input');
                        noteValueInput.type = 'hidden';
                        noteValueInput.name = 'note_value';
                        noteValueInput.value = noteValue;
                        noteForm.appendChild(noteValueInput);

                        document.body.appendChild(noteForm);
                        noteForm.submit();
                    }
                });
            });
        });

        // Set active tab when clicking "Full View" button
        document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(function(button) {
            button.addEventListener('click', function() {
                const tabId = this.getAttribute('href').substring(1);
                const tab = document.getElementById(`${tabId}-tab`);

                if (tab) {
                    const tabInstance = new bootstrap.Tab(tab);
                    tabInstance.show();
                }
            });
        });

        // Refresh run order periodically
        function refreshRunOrder() {
            const currentEventId = "{{ current_event.pk }}";
            const competitionId = "{{ competition.pk }}";

            if (currentEventId && competitionId) {
                fetch(`/competitions/${competitionId}/run-order/event/${currentEventId}/`)
                    .then(response => response.text())
                    .then(html => {
                        document.querySelector('.main-content').innerHTML =
                            new DOMParser().parseFromString(html, 'text/html')
                            .querySelector('.main-content').innerHTML;
                    })
                    .catch(error => console.error('Error refreshing run order:', error));
            }
        }

        setInterval(refreshRunOrder, 30000);
    });
</script>
{% endblock %}