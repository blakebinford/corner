{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load competition_tags %}
{% load flatten %}
{% load values %}
{% load keys %}
{% load get_range %}
{% block extra_css %}
<style>
    .check-in-card {
        margin-bottom: 1rem;
    }
    .athlete-row:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }
    .weigh-in-input {
        max-width: 100px;
    }
    .header-row {
        background-color: #f8f9fa;
        font-weight: bold;
    }
    .badge-present {
        background-color: #28a745;
        color: white;
    }
    .badge-absent {
        background-color: #dc3545;
        color: white;
    }
    .note-row .btn-danger {
        opacity: 0.7;
    }
    .note-row:hover .btn-danger {
        opacity: 1;
    }
    .source-input {
        border: 2px solid #007bff;
        background-color: #e7f0ff;
    }
    .accordion-button:not(.collapsed) {
        background-color: rgba(0, 123, 255, 0.1);
    }
    .tab-content {
        border-left: 1px solid #dee2e6;
        border-right: 1px solid #dee2e6;
        border-bottom: 1px solid #dee2e6;
        padding: 1rem;
    }
    .weight-class-card {
        border-left: 4px solid #6c757d;
    }
    .form-control-xs {
        height: calc(1.5em + 0.5rem + 2px);
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        line-height: 1.5;
        border-radius: 0.2rem;
    }
    .lane-badge {
        font-size: 0.9rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        margin-left: 0.5rem;
    }
    .lane-assigned {
        background-color: #28a745;
        color: white;
    }
    .lane-unassigned {
        background-color: #6c757d;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col">
            <h1 class="display-5">Athlete Check-In: {{ competition.name }}</h1>
            <p class="lead">Check-in athletes and manage event details</p>
        </div>
    </div>
    
    <!-- Bulk Lane Assignment Card -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h4 class="mb-0">Bulk Actions</h4>
        </div>
        <div class="card-body">
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkLaneModal">
                    <i class="bi bi-grid-3x3"></i> Assign Lanes
                </button>
                
                <button type="button" class="btn btn-success" id="checkAllBtn">
                    <i class="bi bi-check-all"></i> Check All Present
                </button>
                
                <button type="button" class="btn btn-danger" id="uncheckAllBtn">
                    <i class="bi bi-x-circle"></i> Uncheck All
                </button>
            </div>
        </div>
    </div>
    
    <form method="post" id="check-in-form">
        {% csrf_token %}
        
        <!-- Tabs for Gender -->
        <ul class="nav nav-tabs mb-3" id="genderTabs" role="tablist">
            {% for gender, weight_classes in grouped_athletes.items %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if forloop.first %}active{% endif %}" 
                            id="tab-{{ gender }}" 
                            data-bs-toggle="tab" 
                            data-bs-target="#panel-{{ gender }}" 
                            type="button" 
                            role="tab">
                        {{ gender|capfirst }} ({{ weight_classes.values|flatten|length }})
                    </button>
                </li>
            {% endfor %}
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content" id="genderTabContent">
            {% for gender, weight_classes in grouped_athletes.items %}
                <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                     id="panel-{{ gender }}" 
                     role="tabpanel">
                    
                    {% for weight_class, athletes in weight_classes.items %}
                        <div class="card weight-class-card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">{{ weight_class }}</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr class="header-row">
                                                <th>Athlete</th>
                                                <th>Division</th>
                                                <th>Present</th>
                                                <th>Weigh-In (lbs)</th>
                                                <th>Event Notes</th>
                                                <th>Lane Assignments</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for athlete in athletes %}
                                                <tr class="athlete-row" 
                                                    data-athlete="{{ athlete.pk }}" 
                                                    data-name="{{ athlete.athlete.user.get_full_name }}" 
                                                    data-gender="{{ athlete.athlete.gender }}" 
                                                    data-division="{{ athlete.division.pk }}" 
                                                    data-weight-class="{{ athlete.weight_class.pk }}">
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div>
                                                                <strong>{{ athlete.athlete.user.get_full_name }}</strong>
                                                                <div class="small text-muted">
                                                                    {{ athlete.athlete.user.email }}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>{{ athlete.division.name }}</td>
                                                    <td>
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" 
                                                                   type="checkbox" 
                                                                   id="showed_up_{{ athlete.pk }}" 
                                                                   name="showed_up_{{ athlete.pk }}"
                                                                   {% if athlete.signed_up %}checked{% endif %}>
                                                            <label class="form-check-label" for="showed_up_{{ athlete.pk }}">
                                                                <span class="badge {% if athlete.signed_up %}badge-present{% else %}badge-absent{% endif %}">
                                                                    {% if athlete.signed_up %}Present{% else %}Absent{% endif %}
                                                                </span>
                                                            </label>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <input type="number" 
                                                               step="0.1" 
                                                               class="form-control form-control-sm weigh-in-input"
                                                               name="weight_in_{{ athlete.pk }}" 
                                                               value="{{ athlete.weigh_in|default:'' }}"
                                                               placeholder="Weight">
                                                    </td>
                                                    <td>
                                                        <button type="button" 
                                                                class="btn btn-outline-primary btn-sm" 
                                                                data-bs-toggle="modal" 
                                                                data-bs-target="#notesModal{{ athlete.pk }}">
                                                            <i class="bi bi-pencil-square"></i> Event Notes
                                                            {% with notes_count=notes_map|get_item:athlete.pk|values|flatten|length %}
                                                                {% if notes_count > 0 %}
                                                                    <span class="badge bg-info">{{ notes_count }}</span>
                                                                {% endif %}
                                                            {% endwith %}
                                                        </button>
                                                        
                                                        <!-- Notes Modal -->
                                                        <div class="modal fade" id="notesModal{{ athlete.pk }}" tabindex="-1" aria-hidden="true">
                                                            <div class="modal-dialog modal-lg">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h5 class="modal-title">
                                                                            Event Notes: {{ athlete.athlete.user.get_full_name }}
                                                                        </h5>
                                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                    </div>
                                                                    <div class="modal-body">
                                                                        <div class="accordion" id="eventNotesAccordion{{ athlete.pk }}">
                                                                            {% for event in events %}
                                                                                <div class="accordion-item">
                                                                                    <h2 class="accordion-header" id="event{{ event.pk }}Heading{{ athlete.pk }}">
                                                                                        <button class="accordion-button collapsed" type="button" 
                                                                                            data-bs-toggle="collapse" 
                                                                                            data-bs-target="#event{{ event.pk }}Collapse{{ athlete.pk }}">
                                                                                            {{ event.name }} ({{ event.get_weight_type_display }})
                                                                                        </button>
                                                                                    </h2>
                                                                                    <div id="event{{ event.pk }}Collapse{{ athlete.pk }}" 
                                                                                        class="accordion-collapse collapse" 
                                                                                        data-bs-parent="#eventNotesAccordion{{ athlete.pk }}">
                                                                                        <div class="accordion-body">
                                                                                            <div class="notes-container" data-athlete="{{ athlete.pk }}" data-event="{{ event.pk }}">
                                                                                                {% with athlete_notes=notes_map|get_item:athlete.pk %}
                                                                                                    {% with event_notes=athlete_notes|get_item:event.pk %}
                                                                                                        {% if event_notes %}
                                                                                                            {% for note_type, note_value in event_notes.items %}
                                                                                                                <div class="note-row mb-2 row">
                                                                                                                    <div class="col-md-4">
                                                                                                                        <select name="note_type_{{ athlete.pk }}_{{ event.pk }}" class="form-select note-type-select">
                                                                                                                            <option value="">-- Select Type --</option>
                                                                                                                            <option value="general" {% if note_type == 'general' %}selected{% endif %}>General Note</option>
                                                                                                                            <option value="equipment" {% if note_type == 'equipment' %}selected{% endif %}>Equipment Note</option>
                                                                                                                            
                                                                                                                            {% if event.weight_type == 'max' %}
                                                                                                                                <option value="opening_weight" {% if note_type == 'opening_weight' %}selected{% endif %}>Opening Weight</option>
                                                                                                                                <option value="next_attempt" {% if note_type == 'next_attempt' %}selected{% endif %}>Next Attempt</option>
                                                                                                                                <option value="rack_height" {% if note_type == 'rack_height' %}selected{% endif %}>Rack Height</option>
                                                                                                                            {% elif event.weight_type == 'time' %}
                                                                                                                                <option value="target_time" {% if note_type == 'target_time' %}selected{% endif %}>Target Time</option>
                                                                                                                                <option value="strategy" {% if note_type == 'strategy' %}selected{% endif %}>Strategy</option>
                                                                                                                            {% elif event.weight_type == 'distance' %}
                                                                                                                                <option value="implement_selection" {% if note_type == 'implement_selection' %}selected{% endif %}>Implement Selection</option>
                                                                                                                            {% elif event.weight_type == 'reps' %}
                                                                                                                                <option value="target_reps" {% if note_type == 'target_reps' %}selected{% endif %}>Target Reps</option>
                                                                                                                            {% endif %}
                                                                                                                            
                                                                                                                            <option value="custom" {% if note_type == 'custom' %}selected{% endif %}>Custom</option>
                                                                                                                        </select>
                                                                                                                    </div>
                                                                                                                    <div class="col-md-6">
                                                                                                                        <input type="text" 
                                                                                                                            name="note_value_{{ athlete.pk }}_{{ event.pk }}" 
                                                                                                                            class="form-control"
                                                                                                                            placeholder="Note value" 
                                                                                                                            value="{{ note_value }}">
                                                                                                                    </div>
                                                                                                                    <div class="col-md-2">
                                                                                                                        <button type="button" class="btn btn-danger btn-sm remove-note">
                                                                                                                            <i class="bi bi-trash"></i>
                                                                                                                        </button>
                                                                                                                    </div>
                                                                                                                </div>
                                                                                                            {% endfor %}
                                                                                                        {% else %}
                                                                                                            <!-- Empty state - show one empty note row -->
                                                                                                            <div class="note-row mb-2 row">
                                                                                                                <div class="col-md-4">
                                                                                                                    <select name="note_type_{{ athlete.pk }}_{{ event.pk }}" class="form-select note-type-select">
                                                                                                                        <option value="">-- Select Type --</option>
                                                                                                                        <option value="general">General Note</option>
                                                                                                                        <option value="equipment">Equipment Note</option>
                                                                                                                        
                                                                                                                        {% if event.weight_type == 'max' %}
                                                                                                                            <option value="opening_weight">Opening Weight</option>
                                                                                                                            <option value="next_attempt">Next Attempt</option>
                                                                                                                            <option value="rack_height">Rack Height</option>
                                                                                                                        {% elif event.weight_type == 'time' %}
                                                                                                                            <option value="target_time">Target Time</option>
                                                                                                                            <option value="strategy">Strategy</option>
                                                                                                                        {% elif event.weight_type == 'distance' %}
                                                                                                                            <option value="implement_selection">Implement Selection</option>
                                                                                                                        {% elif event.weight_type == 'reps' %}
                                                                                                                            <option value="target_reps">Target Reps</option>
                                                                                                                        {% endif %}
                                                                                                                        
                                                                                                                        <option value="custom">Custom</option>
                                                                                                                    </select>
                                                                                                                </div>
                                                                                                                <div class="col-md-6">
                                                                                                                    <input type="text" 
                                                                                                                        name="note_value_{{ athlete.pk }}_{{ event.pk }}" 
                                                                                                                        class="form-control"
                                                                                                                        placeholder="Note value">
                                                                                                                </div>
                                                                                                                <div class="col-md-2">
                                                                                                                    <button type="button" class="btn btn-danger btn-sm remove-note">
                                                                                                                        <i class="bi bi-trash"></i>
                                                                                                                    </button>
                                                                                                                </div>
                                                                                                            </div>
                                                                                                        {% endif %}
                                                                                                    {% endwith %}
                                                                                                {% endwith %}
                                                                                                
                                                                                                <button type="button" class="btn btn-outline-success btn-sm add-note-btn mt-2" 
                                                                                                    data-athlete="{{ athlete.pk }}" 
                                                                                                    data-event="{{ event.pk }}">
                                                                                                    <i class="bi bi-plus-circle"></i> Add Note
                                                                                                </button>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            {% endfor %}
                                                                        </div>
                                                                    </div>
                                                                    <div class="modal-footer">
                                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        {% with lane_count=lanes_map|get_item:athlete.pk|keys|length %}
                                                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                                                data-bs-toggle="modal" 
                                                                data-bs-target="#lanesModal{{ athlete.pk }}">
                                                                <i class="bi bi-grid"></i> Lanes
                                                                {% if lane_count > 0 %}
                                                                    <span class="badge bg-info">{{ lane_count }}</span>
                                                                {% endif %}
                                                            </button>
                                                        {% endwith %}
                                                        
                                                        <!-- Lanes Modal -->
                                                        <div class="modal fade" id="lanesModal{{ athlete.pk }}" tabindex="-1" aria-hidden="true">
                                                            <div class="modal-dialog modal-lg">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h5 class="modal-title">
                                                                            Lane Assignments: {{ athlete.athlete.user.get_full_name }}
                                                                        </h5>
                                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                    </div>
                                                                    <div class="modal-body">
                                                                        <div class="table-responsive">
                                                                            <table class="table table-bordered">
                                                                                <thead>
                                                                                    <tr>
                                                                                        <th>Event</th>
                                                                                        <th>Lanes Available</th>
                                                                                        <th>Lane</th>
                                                                                        <th>Heat</th>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody>
                                                                                    {% for event in events %}
    {% if event.number_of_lanes > 1 %}
        {% if athlete.pk in lanes_map %}
            {% with athlete_lanes=lanes_map|get_item:athlete.pk %}
                {% if event.pk in athlete_lanes %}
                    {% with event_lane=athlete_lanes|get_item:event.pk %}
                        <tr>
                            <td>{{ event.name }}</td>
                            <td>{{ event.number_of_lanes }}</td>
                            <td>
                                <select name="lane_{{ athlete.pk }}_{{ event.pk }}" class="form-select">
                                    <option value="">-- Select Lane --</option>
                                    {% for i in event.number_of_lanes|get_range %}
                                        <option value="{{ i }}" 
                                            {% if event_lane and event_lane.lane == i %}selected{% endif %}>
                                            Lane {{ i }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="number" 
                                    name="heat_{{ athlete.pk }}_{{ event.pk }}" 
                                    class="form-control" 
                                    min="1" 
                                    value="{{ event_lane.heat|default:'1' }}">
                            </td>
                        </tr>
                    {% endwith %}
                {% else %}
                    <tr>
                        <td>{{ event.name }}</td>
                        <td>{{ event.number_of_lanes }}</td>
                        <td>
                            <select name="lane_{{ athlete.pk }}_{{ event.pk }}" class="form-select">
                                <option value="">-- Select Lane --</option>
                                {% for i in event.number_of_lanes|get_range %}
                                    <option value="{{ i }}">Lane {{ i }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <input type="number" 
                                name="heat_{{ athlete.pk }}_{{ event.pk }}" 
                                class="form-control" 
                                min="1" 
                                value="1">
                        </td>
                    </tr>
                {% endif %}
            {% endwith %}
        {% else %}
            <tr>
                <td>{{ event.name }}</td>
                <td>{{ event.number_of_lanes }}</td>
                <td>
                    <select name="lane_{{ athlete.pk }}_{{ event.pk }}" class="form-select">
                        <option value="">-- Select Lane --</option>
                        {% for i in event.number_of_lanes|get_range %}
                            <option value="{{ i }}">Lane {{ i }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <input type="number" 
                        name="heat_{{ athlete.pk }}_{{ event.pk }}" 
                        class="form-control" 
                        min="1" 
                        value="1">
                </td>
            </tr>
        {% endif %}
    {% endif %}
{% endfor %}
                                                                                </tbody>
                                                                            </table>
                                                                        </div>
                                                                    </div>
                                                                    <div class="modal-footer">
                                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
        
        <div class="row mt-4 mb-5">
            <div class="col">
                <button type="submit" name="save_check_in" class="btn btn-primary btn-lg">
                    <i class="bi bi-save"></i> Save Check-In Data
                </button>
                <button type="submit" name="finalize_check_in" class="btn btn-warning btn-lg ms-2" 
                    onclick="return confirm('This will remove all athletes who did not check in. Are you sure?')">
                    <i class="bi bi-check-circle"></i> Finalize Check-In
                </button>
            </div>
        </div>
    </form>
    


    <!-- Bulk Lane Assignment Modal -->
    <div class="modal fade" id="bulkLaneModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bulk Lane Assignment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="bulk-event" class="form-label">Event</label>
                            <select id="bulk-event" class="form-select">
                                <option value="">-- Select Event --</option>
                                {% for event in events %}
                                    {% if event.number_of_lanes > 1 %}
                                        <option value="{{ event.pk }}" data-lanes="{{ event.number_of_lanes }}">
                                            {{ event.name }} ({{ event.number_of_lanes }} lanes)
                                        </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="bulk-gender" class="form-label">Gender</label>
                            <select id="bulk-gender" class="form-select">
                                <option value="">All Genders</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="bulk-division" class="form-label">Division</label>
                            <select id="bulk-division" class="form-select">
                                <option value="">All Divisions</option>
                                {% for division in competition.allowed_divisions.all %}
                                    <option value="{{ division.pk }}">{{ division.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="bulk-weight-class" class="form-label">Weight Class</label>
                            <select id="bulk-weight-class" class="form-select">
                                <option value="">All Weight Classes</option>
                                {% for weight_class in competition.allowed_weight_classes.all %}
                                    <option value="{{ weight_class.pk }}">{{ weight_class.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="bulk-assignment-type" class="form-label">Assignment Type</label>
                            <select id="bulk-assignment-type" class="form-select">
                                <option value="sequential">Sequential (1, 2, 3...)</option>
                                <option value="alternating">Alternating Lanes (1, 3, 5... then 2, 4, 6...)</option>
                                <option value="random">Random</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="bulk-heat" class="form-label">Heat Number</label>
                            <input type="number" id="bulk-heat" class="form-control" min="1" value="1">
                        </div>
                    </div>
                    
                    <div id="bulk-lane-preview" class="mt-4">
                        <!-- Preview of assignments will be shown here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="apply-bulk-lanes">Apply Lane Assignments</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle badge class when checkbox is changed
    document.querySelectorAll('input[id^="showed_up_"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const badge = this.nextElementSibling.querySelector('.badge');
            if (this.checked) {
                badge.classList.remove('badge-absent');
                badge.classList.add('badge-present');
                badge.textContent = 'Present';
            } else {
                badge.classList.remove('badge-present');
                badge.classList.add('badge-absent');
                badge.textContent = 'Absent';
            }
        });
    });
    
    // Check/Uncheck All Buttons
    document.getElementById('checkAllBtn').addEventListener('click', function() {
        document.querySelectorAll('input[id^="showed_up_"]').forEach(checkbox => {
            checkbox.checked = true;
            const badge = checkbox.nextElementSibling.querySelector('.badge');
            badge.classList.remove('badge-absent');
            badge.classList.add('badge-present');
            badge.textContent = 'Present';
        });
    });
    
    document.getElementById('uncheckAllBtn').addEventListener('click', function() {
        document.querySelectorAll('input[id^="showed_up_"]').forEach(checkbox => {
            checkbox.checked = false;
            const badge = checkbox.nextElementSibling.querySelector('.badge');
            badge.classList.remove('badge-present');
            badge.classList.add('badge-absent');
            badge.textContent = 'Absent';
        });
    });
    
    // Notes functionality
    // Add note button functionality
    document.querySelectorAll('.add-note-btn').forEach(button => {
        button.addEventListener('click', function() {
            const athleteId = this.dataset.athlete;
            const eventId = this.dataset.event;
            const container = document.querySelector(`.notes-container[data-athlete="${athleteId}"][data-event="${eventId}"]`);
            
            // Clone the first note row as a template
            const template = container.querySelector('.note-row').cloneNode(true);
            
            // Clear the values
            template.querySelector('select').value = '';
            template.querySelector('input').value = '';
            
            // Insert before the add button
            container.insertBefore(template, this);
            
            // Add event listeners to the new elements
            addNoteRowListeners(template);
        });
    });
    
    // Function to add event listeners to note row elements
    function addNoteRowListeners(row) {
        const removeButton = row.querySelector('.remove-note');
        if (removeButton) {
            removeButton.addEventListener('click', function() {
                if (confirm('Remove this note?')) {
                    row.remove();
                }
            });
        }
    }
    
    // Add listeners to existing rows
    document.querySelectorAll('.note-row').forEach(row => {
        addNoteRowListeners(row);
    });
    
    // Bulk lane assignment functionality
    const bulkEvent = document.getElementById('bulk-event');
    const bulkGender = document.getElementById('bulk-gender');
    const bulkDivision = document.getElementById('bulk-division');
    const bulkWeightClass = document.getElementById('bulk-weight-class');
    const bulkAssignmentType = document.getElementById('bulk-assignment-type');
    const bulkHeat = document.getElementById('bulk-heat');
    const bulkPreview = document.getElementById('bulk-lane-preview');
    const applyBulkLanes = document.getElementById('apply-bulk-lanes');
    
    if (bulkEvent && bulkPreview && applyBulkLanes) {
        // Debug log available genders and weight classes
        console.log("Available genders:");
        document.querySelectorAll('tr[data-athlete]').forEach(row => {
            console.log(`Athlete ${row.dataset.name}: Gender=${row.dataset.gender}`);
        });
        
        console.log("Available weight classes:");
        document.querySelectorAll('tr[data-athlete]').forEach(row => {
            console.log(`Athlete ${row.dataset.name}: Weight Class=${row.dataset.weightClass}`);
        });
        
        // Function to get filtered athletes
        function getFilteredAthletes() {
            const gender = bulkGender.value;
            const division = bulkDivision.value;
            const weightClass = bulkWeightClass.value;
            
            // Find qualifying athletes
            const athletes = [];
            document.querySelectorAll('tr[data-athlete]').forEach(row => {
                const athleteId = row.dataset.athlete;
                const athleteName = row.dataset.name;
                const athleteGender = row.dataset.gender;
                const athleteDivision = row.dataset.division;
                const athleteWeightClass = row.dataset.weightClass;
                
                const genderMatch = !gender || athleteGender.toLowerCase() === gender.toLowerCase();
                const divisionMatch = !division || athleteDivision === division;
                const weightClassMatch = !weightClass || athleteWeightClass === weightClass;
                
                if (genderMatch && divisionMatch && weightClassMatch) {
                    athletes.push({
                        id: athleteId,
                        name: athleteName,
                        gender: athleteGender,
                        division: athleteDivision,
                        weightClass: athleteWeightClass
                    });
                }
            });
            
            return athletes;
        }
        
        // Function to assign lanes to filtered athletes
        function assignLanes(athletes, maxLanes, assignmentType, heat) {
            const laneAssignments = [];
            
            if (assignmentType === 'sequential') {
                // Simply assign lanes 1, 2, 3, etc. (loop back to 1 if needed)
                athletes.forEach((athlete, index) => {
                    const lane = (index % maxLanes) + 1;
                    laneAssignments.push({
                        athlete: athlete,
                        lane: lane,
                        heat: heat
                    });
                });
            } else if (assignmentType === 'alternating') {
                // Assign odd lanes first, then even lanes
                const oddLanes = [];
                const evenLanes = [];
                
                for (let i = 1; i <= maxLanes; i++) {
                    if (i % 2 === 1) {
                        oddLanes.push(i);
                    } else {
                        evenLanes.push(i);
                    }
                }
                
                const allLanes = [...oddLanes, ...evenLanes];
                
                athletes.forEach((athlete, index) => {
                    const lane = allLanes[index % allLanes.length];
                    laneAssignments.push({
                        athlete: athlete,
                        lane: lane,
                        heat: heat
                    });
                });
            } else if (assignmentType === 'random') {
                // Shuffle athletes and assign lanes
                const shuffledAthletes = [...athletes].sort(() => Math.random() - 0.5);
                
                shuffledAthletes.forEach((athlete, index) => {
                    const lane = (index % maxLanes) + 1;
                    laneAssignments.push({
                        athlete: athlete,
                        lane: lane,
                        heat: heat
                    });
                });
            }
            
            return laneAssignments;
        }
        
        // Function to preview assignments
        function previewLaneAssignments() {
            const eventId = bulkEvent.value;
            if (!eventId) {
                bulkPreview.innerHTML = '<div class="alert alert-warning">Please select an event.</div>';
                return;
            }
            
            const event = bulkEvent.options[bulkEvent.selectedIndex].text;
            const gender = bulkGender.value;
            const division = bulkDivision.value;
            const weightClass = bulkWeightClass.value;
            const assignmentType = bulkAssignmentType.value;
            const heat = bulkHeat.value;
            const maxLanes = parseInt(bulkEvent.options[bulkEvent.selectedIndex].dataset.lanes);
            
            console.log("Filter criteria:", {
                gender: gender,
                division: division,
                weightClass: weightClass
            });
            
            // Get filtered athletes
            const athletes = getFilteredAthletes();
            
            // Debug log the matching criteria for each athlete
            document.querySelectorAll('tr[data-athlete]').forEach(row => {
                const athleteGender = row.dataset.gender;
                const athleteDivision = row.dataset.division;
                const athleteWeightClass = row.dataset.weightClass;
                
                const genderMatch = !gender || athleteGender.toLowerCase() === gender.toLowerCase();
                const divisionMatch = !division || athleteDivision === division;
                const weightClassMatch = !weightClass || athleteWeightClass === weightClass;
                
                console.log(`Athlete ${row.dataset.name}: Gender ${athleteGender} (match: ${genderMatch}), Division ${athleteDivision} (match: ${divisionMatch}), Weight Class ${athleteWeightClass} (match: ${weightClassMatch})`);
            });
            
            if (athletes.length === 0) {
                bulkPreview.innerHTML = '<div class="alert alert-warning">No athletes match the selected criteria.</div>';
                return;
            }
            
            // Assign lanes based on selected strategy
            const laneAssignments = assignLanes(athletes, maxLanes, assignmentType, heat);
            
            // Display preview
            let previewHtml = `
                <h5>Preview: ${event}</h5>
                <p>Assigning ${athletes.length} athletes to ${maxLanes} lanes using ${assignmentType} strategy in Heat ${heat}.</p>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                <th>Athlete</th>
                                <th>Lane</th>
                                <th>Heat</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            laneAssignments.forEach(assignment => {
                previewHtml += `
                    <tr>
                        <td>${assignment.athlete.name}</td>
                        <td>${assignment.lane}</td>
                        <td>${assignment.heat}</td>
                    </tr>
                `;
            });
            
            previewHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            bulkPreview.innerHTML = previewHtml;
            
            // Store assignments for application
            bulkPreview.dataset.assignments = JSON.stringify(laneAssignments);
        }
        
        console.log("Gender dropdown options:", Array.from(bulkGender.options).map(opt => ({ value: opt.value, text: opt.text })));
        
        // Load weight classes based on selected gender
        bulkGender.addEventListener('change', function() {
            const selectedGender = this.value;
            console.log("Selected gender:", selectedGender);
            const weightClassSelect = document.getElementById('bulk-weight-class');
            
            // Reset the weight class options
            weightClassSelect.innerHTML = '<option value="">All Weight Classes</option>';
            
            // Get unique weight classes for the selected gender
            const weightClasses = new Map(); // Using Map to store { id: name } pairs
            
            document.querySelectorAll('tr[data-athlete]').forEach(row => {
                if (!selectedGender || row.dataset.gender.toLowerCase() === selectedGender.toLowerCase()) {
                    const weightClassId = row.dataset.weightClass;
                    let weightClassName = 'Unknown';
                    
                    // Try to get the weight class name from the card header
                    const cardHeader = row.closest('.weight-class-card')?.querySelector('.card-header h5');
                    if (cardHeader) {
                        weightClassName = cardHeader.textContent.trim();
                    }
                    
                    if (weightClassId && !weightClasses.has(weightClassId)) {
                        weightClasses.set(weightClassId, weightClassName);
                    }
                }
            });
            
            // Add options for each weight class
            weightClasses.forEach((name, id) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                weightClassSelect.appendChild(option);
            });
            
            // Trigger the preview update
            previewLaneAssignments();
        });
        
        // Add event listeners
        [bulkEvent, bulkGender, bulkDivision, bulkWeightClass, bulkAssignmentType, bulkHeat].forEach(element => {
            if (element) {
                element.addEventListener('change', previewLaneAssignments);
            }
        });
        
        // Apply button handler - completely rewritten
        applyBulkLanes.addEventListener('click', function() {
            const eventId = bulkEvent.value;
            if (!eventId) {
                alert('Please select an event.');
                return;
            }
            
            const gender = bulkGender.value;
            const division = bulkDivision.value;
            const weightClass = bulkWeightClass.value;
            const assignmentType = bulkAssignmentType.value;
            const heat = bulkHeat.value;
            const maxLanes = parseInt(bulkEvent.options[bulkEvent.selectedIndex].dataset.lanes);
            
            console.log("Applying bulk lane assignments with filters:", {
                gender: gender,
                division: division,
                weightClass: weightClass
            });
            
            // Get filtered athletes directly
            const filteredAthletes = getFilteredAthletes();
            console.log("Filtered athletes:", filteredAthletes);
            
            if (filteredAthletes.length === 0) {
                alert('No athletes match the selected criteria.');
                return;
            }
            
            // Generate lane assignments again (to ensure they match what was displayed)
            const laneAssignments = assignLanes(filteredAthletes, maxLanes, assignmentType, heat);
            
            // Create a map for quick lookup of assignments
            const assignmentMap = new Map();
            laneAssignments.forEach(assignment => {
                assignmentMap.set(assignment.athlete.id, {
                    lane: assignment.lane,
                    heat: assignment.heat
                });
            });
            
            // Update form fields for ONLY the filtered athletes
            let updatedCount = 0;
            filteredAthletes.forEach(athlete => {
                const athleteId = athlete.id;
                const assignment = assignmentMap.get(athleteId);
                
                if (assignment) {
                    const laneSelect = document.querySelector(`select[name="lane_${athleteId}_${eventId}"]`);
                    const heatInput = document.querySelector(`input[name="heat_${athleteId}_${eventId}"]`);
                    
                    if (laneSelect) {
                        console.log(`Setting lane ${assignment.lane} for athlete ${athleteId} (${athlete.name})`);
                        laneSelect.value = assignment.lane;
                    }
                    
                    if (heatInput) {
                        console.log(`Setting heat ${assignment.heat} for athlete ${athleteId} (${athlete.name})`);
                        heatInput.value = assignment.heat;
                    }
                    
                    updatedCount++;
                }
            });
            
            // Close modal
            const modal = document.getElementById('bulkLaneModal');
            const modalInstance = bootstrap.Modal.getInstance(modal);
            if (modalInstance) {
                modalInstance.hide();
            }
            
            // Show success message
            alert(`Successfully applied lane assignments for ${updatedCount} athletes.`);
        });
    }
    
    // Form submission confirmation
    document.getElementById('check-in-form').addEventListener('submit', function(e) {
        if (e.submitter && e.submitter.name === 'save_check_in') {
            // Allow normal submission for save_check_in
            return true;
        }
        
        // For finalize_check_in, confirm is handled by the onclick attribute
        return true;
    });
});
</script>
{% endblock %}
{% endblock %}